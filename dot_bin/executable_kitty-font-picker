#!/usr/bin/env bash

set -euo pipefail

# ============================================================================
# Kitty Font Picker - Interactive font configuration utility
# ============================================================================

# Configuration
CHEZMOI_CONFIG="${HOME}/.config/chezmoi/chezmoi.yaml"
BACKUP_FILE="${CHEZMOI_CONFIG}.backup-$(date +%s)"
PRESETS_DIR="${HOME}/.config/kitty-font-picker/presets"

# Colors
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m' # No Color

# Cleanup function
cleanup() {
    if [ $? -ne 0 ]; then
        echo -e "${RED}âš ï¸  Unexpected exit. Backup preserved at: ${BACKUP_FILE}${NC}"
    fi
}

trap cleanup EXIT

# ============================================================================
# Helper Functions
# ============================================================================

log_info() {
    echo -e "${BLUE}â„¹${NC} $*"
}

log_success() {
    echo -e "${GREEN}âœ“${NC} $*"
}

log_warn() {
    echo -e "${YELLOW}âš ${NC} $*"
}

log_error() {
    echo -e "${RED}âœ—${NC} $*"
}

# Backup the original file
create_backup() {
    if [ ! -f "$CHEZMOI_CONFIG" ]; then
        log_error "Chezmoi config file not found: $CHEZMOI_CONFIG"
        exit 1
    fi

    cp "$CHEZMOI_CONFIG" "$BACKUP_FILE"
    log_success "Backup created: $BACKUP_FILE"
}

# Restore from backup
restore_backup() {
    if [ -f "$BACKUP_FILE" ]; then
        cp "$BACKUP_FILE" "$CHEZMOI_CONFIG"
        log_success "Configuration restored from backup"
        rm -f "$BACKUP_FILE"
    fi
}

# Read YAML value (using jq-style yq)
read_yaml_value() {
    local key=$1
    # Prepend "data." to access the data section in chezmoi.yaml
    local jq_path=".data.${key}"
    yq "$jq_path" "$CHEZMOI_CONFIG" 2>/dev/null | sed 's/"//g' || echo ""
}

# Write YAML value (using jq-style yq)
write_yaml_value() {
    local key=$1
    local value=$2

    # Prepend "data." to access the data section in chezmoi.yaml
    local jq_path=".data.${key}"

    # Use yq with --yaml-output and --in-place
    yq --yaml-output --in-place "${jq_path} = \"${value}\"" "$CHEZMOI_CONFIG"
}

# Apply changes and reload kitty
apply_and_reload() {
    log_info "Applying changes..."

    # Force apply chezmoi template (data changes don't auto-trigger)
    if ! chezmoi apply --force ~/.config/kitty/kitty.conf 2>/dev/null; then
        log_error "Failed to apply chezmoi configuration"
        return 1
    fi

    reload_kitty
}

# Reload kitty configuration
reload_kitty() {
    # Reload kitty - SIGUSR1 triggers config reload
    if pgrep -x kitty > /dev/null; then
        pkill -SIGUSR1 kitty 2>/dev/null && log_success "Kitty configuration reloaded" || {
            log_warn "Could not send reload signal"
            log_info "Restart kitty to see changes"
        }
    else
        log_warn "Kitty is not running - changes will apply on next start"
    fi

    sleep 0.3  # Brief pause for reload
}

# Restore kitty.conf from chezmoi (undo preview)
restore_from_chezmoi() {
    chezmoi apply --force ~/.config/kitty/kitty.conf 2>/dev/null
    reload_kitty
}

# Live preview helper - called by fzf on focus change
# Usage: preview_live <setting> <value>
preview_live() {
    local setting="$1"
    local value="$2"
    local kitty_conf="${HOME}/.config/kitty/kitty.conf"

    sed -i "s|^${setting} .*|${setting} ${value}|" "$kitty_conf"
    pkill -SIGUSR1 kitty 2>/dev/null &
}

# Export for fzf subshell
export -f preview_live

# ============================================================================
# Preset Functions
# ============================================================================

# Ensure presets directory exists
ensure_presets_dir() {
    mkdir -p "$PRESETS_DIR"
}

# Get all preset names (without .yaml extension)
list_presets() {
    ensure_presets_dir
    find "$PRESETS_DIR" -maxdepth 1 -name "*.yaml" -type f -exec basename {} .yaml \; 2>/dev/null | sort
}

# Get current settings as YAML
get_current_settings_yaml() {
    cat <<EOF
font: $(read_yaml_value 'kitty.font')
fontSize: $(read_yaml_value 'kitty.fontSize')
cellHeight: $(read_yaml_value 'kitty.cellHeight')
cellWidth: $(read_yaml_value 'kitty.cellWidth')
styleNormal: $(read_yaml_value 'kitty.styleNormal')
styleBold: $(read_yaml_value 'kitty.styleBold')
styleItalic: $(read_yaml_value 'kitty.styleItalic')
styleBoldItalic: $(read_yaml_value 'kitty.styleBoldItalic')
EOF
}

# Save current settings as a preset
save_preset() {
    ensure_presets_dir

    local name=$(gum input --placeholder "Preset name (e.g., coding, presentation)" --header "ðŸ’¾ Save Preset")

    if [[ -z "$name" ]]; then
        log_info "Cancelled"
        return
    fi

    # Sanitize name (replace spaces with dashes, remove special chars)
    name=$(echo "$name" | tr ' ' '-' | tr -cd '[:alnum:]-_')
    local preset_file="${PRESETS_DIR}/${name}.yaml"

    if [[ -f "$preset_file" ]]; then
        if ! gum confirm "Preset '$name' already exists. Overwrite?"; then
            log_info "Cancelled"
            return
        fi
    fi

    get_current_settings_yaml > "$preset_file"
}

# Apply a preset file to chezmoi config
apply_preset_file() {
    local preset_file="$1"

    if [[ ! -f "$preset_file" ]]; then
        log_error "Preset file not found: $preset_file"
        return 1
    fi

    # Read each value from preset and write to chezmoi config
    local font=$(yq '.font' "$preset_file" 2>/dev/null | sed 's/"//g')
    local fontSize=$(yq '.fontSize' "$preset_file" 2>/dev/null | sed 's/"//g')
    local cellHeight=$(yq '.cellHeight' "$preset_file" 2>/dev/null | sed 's/"//g')
    local cellWidth=$(yq '.cellWidth' "$preset_file" 2>/dev/null | sed 's/"//g')
    local styleNormal=$(yq '.styleNormal' "$preset_file" 2>/dev/null | sed 's/"//g')
    local styleBold=$(yq '.styleBold' "$preset_file" 2>/dev/null | sed 's/"//g')
    local styleItalic=$(yq '.styleItalic' "$preset_file" 2>/dev/null | sed 's/"//g')
    local styleBoldItalic=$(yq '.styleBoldItalic' "$preset_file" 2>/dev/null | sed 's/"//g')

    [[ -n "$font" && "$font" != "null" ]] && write_yaml_value "kitty.font" "$font"
    [[ -n "$fontSize" && "$fontSize" != "null" ]] && write_yaml_value "kitty.fontSize" "$fontSize"
    [[ -n "$cellHeight" && "$cellHeight" != "null" ]] && write_yaml_value "kitty.cellHeight" "$cellHeight"
    [[ -n "$cellWidth" && "$cellWidth" != "null" ]] && write_yaml_value "kitty.cellWidth" "$cellWidth"
    [[ -n "$styleNormal" && "$styleNormal" != "null" ]] && write_yaml_value "kitty.styleNormal" "$styleNormal"
    [[ -n "$styleBold" && "$styleBold" != "null" ]] && write_yaml_value "kitty.styleBold" "$styleBold"
    [[ -n "$styleItalic" && "$styleItalic" != "null" ]] && write_yaml_value "kitty.styleItalic" "$styleItalic"
    [[ -n "$styleBoldItalic" && "$styleBoldItalic" != "null" ]] && write_yaml_value "kitty.styleBoldItalic" "$styleBoldItalic"
}

# Preview helper for presets - applies preset live
preview_preset_live() {
    local preset_name="$1"
    local preset_file="${PRESETS_DIR}/${preset_name}.yaml"
    local kitty_conf="${HOME}/.config/kitty/kitty.conf"

    if [[ ! -f "$preset_file" ]]; then
        return
    fi

    # Read preset values
    local font=$(yq '.font' "$preset_file" 2>/dev/null | sed 's/"//g')
    local fontSize=$(yq '.fontSize' "$preset_file" 2>/dev/null | sed 's/"//g')
    local cellHeight=$(yq '.cellHeight' "$preset_file" 2>/dev/null | sed 's/"//g')
    local cellWidth=$(yq '.cellWidth' "$preset_file" 2>/dev/null | sed 's/"//g')
    local styleNormal=$(yq '.styleNormal' "$preset_file" 2>/dev/null | sed 's/"//g')

    # Apply to kitty.conf directly for live preview (using kitty's family='...' style=... format)
    [[ -n "$font" && "$font" != "null" ]] && sed -i "s|^font_family.*|font_family      family='$font' style=$styleNormal|" "$kitty_conf"
    [[ -n "$fontSize" && "$fontSize" != "null" ]] && sed -i "s|^font_size.*|font_size $fontSize|" "$kitty_conf"
    [[ -n "$cellHeight" && "$cellHeight" != "null" ]] && sed -i "s|^modify_font cell_height.*|modify_font cell_height $cellHeight|" "$kitty_conf"
    [[ -n "$cellWidth" && "$cellWidth" != "null" ]] && sed -i "s|^modify_font cell_width.*|modify_font cell_width $cellWidth|" "$kitty_conf"

    pkill -SIGUSR1 kitty 2>/dev/null &
}

# Export for fzf subshell
export PRESETS_DIR
export -f preview_preset_live

# Load a preset with fzf preview
load_preset() {
    local presets=$(list_presets)

    if [[ -z "$presets" ]]; then
        log_warn "No presets found. Save one first!"
        return
    fi

    local original_font=$(read_yaml_value 'kitty.font')

    # fzf with YAML preview and live kitty preview
    local selected=$(echo "$presets" | fzf \
        --header "ðŸ“‚ Load Preset (â†‘â†“ to preview, Enter to load, Esc to cancel)" \
        --prompt "â¯ " \
        --height 15 \
        --layout reverse \
        --preview "cat '${PRESETS_DIR}/{}.yaml' 2>/dev/null | head -20" \
        --preview-window "right:50%:wrap" \
        --bind "focus:execute-silent:preview_preset_live {}")

    if [[ -n "$selected" ]]; then
        local preset_file="${PRESETS_DIR}/${selected}.yaml"
        apply_preset_file "$preset_file"
        apply_and_reload
    else
        # User cancelled - restore original
        restore_from_chezmoi
    fi
}

# Delete presets with multi-select
delete_presets() {
    local presets=$(list_presets)

    if [[ -z "$presets" ]]; then
        log_warn "No presets to delete"
        return
    fi

    local selected=$(echo "$presets" | fzf \
        --header "ðŸ—‘ï¸  Select presets to delete (Tab to select, Enter to confirm)" \
        --prompt "â¯ " \
        --height 15 \
        --layout reverse \
        --multi \
        --preview "cat '${PRESETS_DIR}/{}.yaml' 2>/dev/null")

    if [[ -z "$selected" ]]; then
        return
    fi

    local count=$(echo "$selected" | wc -l)

    if gum confirm "Delete $count preset(s)?"; then
        echo "$selected" | while read -r preset; do
            rm -f "${PRESETS_DIR}/${preset}.yaml"
        done
    fi
}

# Presets submenu
presets_menu() {
    local last_choice=""

    while true; do
        clear
        show_banner
        local choice=$(gum choose \
            "ðŸ’¾ Save current as preset" \
            "ðŸ“‚ Load preset" \
            "ðŸ—‘ï¸  Delete presets" \
            "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" \
            "â† Back to main menu" \
            --height 8 \
            --header "ðŸ“¦ Presets" \
            ${last_choice:+--selected="$last_choice"})

        case "$choice" in
            "ðŸ’¾ Save current as preset")
                last_choice="$choice"
                save_preset
                ;;
            "ðŸ“‚ Load preset")
                last_choice="$choice"
                load_preset
                ;;
            "ðŸ—‘ï¸  Delete presets")
                last_choice="$choice"
                delete_presets
                ;;
            "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
                # Separator - do nothing, will refresh
                continue
                ;;
            "â† Back to main menu"|"")
                return
                ;;
        esac
    done
}

# ============================================================================
# Font Functions
# ============================================================================

# Get available font families
get_font_families() {
    fc-list : family | sed 's/,.*$//' | grep -i "mono\|nerd\|code\|consol\|hack\|jetbrains\|fira\|source" | sort -u
}

# Get available styles for a font
get_font_styles() {
    local font_name=$1
    fc-list "$font_name" : style | sed 's/:style=//g' | sed 's/,/\n/g' | sort -u | grep -v "^$"
}

# Display current configuration banner
show_banner() {
    clear
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "         ðŸŽ¨ Kitty Font Picker"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
}

# ============================================================================
# Menu Functions
# ============================================================================

select_font_family() {
    local current_font=$(read_yaml_value 'kitty.font')
    local original_font="$current_font"

    echo -e "${BLUE}â„¹${NC} Loading fonts... (current: ${YELLOW}$current_font${NC})"
    local fonts=$(get_font_families)

    # Use fzf with live preview on arrow navigation
    local selected_font=$(echo "$fonts" | fzf \
        --header "ðŸ” Select Font Family (â†‘â†“ to preview, Enter to select, Esc to cancel)" \
        --prompt "â¯ " \
        --height 20 \
        --layout reverse \
        --bind 'focus:execute-silent:preview_live font_family {}' \
        --query "" \
        --select-1 \
        --exit-0)

    if [ -n "$selected_font" ]; then
        # User selected a font - save to chezmoi config
        write_yaml_value "kitty.font" "$selected_font"
        echo -e "${GREEN}âœ“${NC} Font saved: ${YELLOW}$original_font${NC} â†’ ${GREEN}$selected_font${NC}"
        apply_and_reload
    else
        # User cancelled - restore original
        restore_from_chezmoi
        echo -e "${BLUE}â„¹${NC} Restored: ${YELLOW}$original_font${NC}"
    fi
}

select_font_style() {
    local style_type=$1
    local yaml_key=$2
    local current_style=$(read_yaml_value "$yaml_key")
    local original_style="$current_style"
    local current_font=$(read_yaml_value 'kitty.font')

    # Map style type to kitty.conf setting name
    local kitty_setting
    case "$style_type" in
        "Normal") kitty_setting="font_family" ;;
        "Bold") kitty_setting="bold_font" ;;
        "Italic") kitty_setting="italic_font" ;;
        "Bold+Italic") kitty_setting="bold_italic_font" ;;
    esac

    echo -e "${BLUE}â„¹${NC} Loading styles for ${YELLOW}$current_font${NC}... (current: ${YELLOW}$current_style${NC})"
    local styles=$(get_font_styles "$current_font")

    if [ -z "$styles" ]; then
        styles=$(echo -e "Regular\nBold\nItalic\nBold Italic\nLight\nMedium\nSemiBold\nExtraLight\nBlack")
    fi

    # Use fzf with live preview on arrow navigation
    local selected_style=$(echo "$styles" | fzf \
        --header "ðŸ” Select $style_type Style (â†‘â†“ to preview, Enter to select, Esc to cancel)" \
        --prompt "â¯ " \
        --height 15 \
        --layout reverse \
        --bind "focus:execute-silent:preview_live $kitty_setting {}" \
        --query "" \
        --select-1 \
        --exit-0)

    if [ -n "$selected_style" ]; then
        # User selected a style - save to chezmoi config
        write_yaml_value "$yaml_key" "$selected_style"
        echo -e "${GREEN}âœ“${NC} $style_type style saved: ${YELLOW}$original_style${NC} â†’ ${GREEN}$selected_style${NC}"
        apply_and_reload
    else
        # User cancelled - restore original
        restore_from_chezmoi
        echo -e "${BLUE}â„¹${NC} Restored: ${YELLOW}$original_style${NC}"
    fi
}

adjust_font_size() {
    local current_size=$(read_yaml_value 'kitty.fontSize')
    local original_size="$current_size"

    # Generate common font sizes
    local sizes=$(printf '%s\n' 8 9 10 11 12 13 14 15 16 17 18 19 20 22 24 26 28 32 36)

    # Use fzf with live preview on arrow navigation (type custom size or select from list)
    local new_size=$(echo "$sizes" | fzf \
        --header "ðŸ“ Font Size (â†‘â†“ to preview, type custom size, Enter to select)" \
        --prompt "â¯ " \
        --height 15 \
        --layout reverse \
        --print-query \
        --bind 'focus:execute-silent:preview_live font_size {}' \
        --query "$current_size" | tail -1)

    if [ -n "$new_size" ]; then
        # Validate input
        if ! [[ "$new_size" =~ ^[0-9]+\.?[0-9]*$ ]]; then
            echo -e "${RED}âœ—${NC} Invalid size (must be a number)"
            restore_from_chezmoi
            return
        fi
        # User selected a size - save to chezmoi config
        write_yaml_value "kitty.fontSize" "$new_size"
        echo -e "${GREEN}âœ“${NC} Size saved: ${YELLOW}${original_size}${NC} â†’ ${GREEN}${new_size}${NC}"
        apply_and_reload
    else
        # User cancelled - restore original
        restore_from_chezmoi
        echo -e "${BLUE}â„¹${NC} Restored: ${YELLOW}$original_size${NC}"
    fi
}

adjust_cell_dimension() {
    local dimension=$1  # "Height" or "Width"
    local yaml_key="kitty.cell${dimension}"
    local current_value=$(read_yaml_value "$yaml_key")
    local original_value="$current_value"
    local kitty_setting="modify_font cell_${dimension,,}"

    # Generate common cell dimension percentages
    local values=$(printf '%s\n' 90% 95% 100% 105% 110% 115% 120% 125% 130% 140% 150%)

    # Use fzf with live preview on arrow navigation
    local new_value=$(echo "$values" | fzf \
        --header "ðŸ“ Cell $dimension (â†‘â†“ to preview, type custom value, Enter to select)" \
        --prompt "â¯ " \
        --height 15 \
        --layout reverse \
        --print-query \
        --bind "focus:execute-silent:preview_live '$kitty_setting' {}" \
        --query "$current_value" | tail -1)

    if [ -n "$new_value" ]; then
        # User selected a value - save to chezmoi config
        write_yaml_value "$yaml_key" "$new_value"
        echo -e "${GREEN}âœ“${NC} Cell $dimension saved: ${YELLOW}${original_value}${NC} â†’ ${GREEN}${new_value}${NC}"
        apply_and_reload
    else
        # User cancelled - restore original
        restore_from_chezmoi
        echo -e "${BLUE}â„¹${NC} Restored: ${YELLOW}$original_value${NC}"
    fi
}

# Main menu with inline values
main_menu() {
    local last_choice=""

    while true; do
        show_banner

        # Get current values
        local font=$(read_yaml_value 'kitty.font')
        local size=$(read_yaml_value 'kitty.fontSize')
        local height=$(read_yaml_value 'kitty.cellHeight')
        local width=$(read_yaml_value 'kitty.cellWidth')
        local normal=$(read_yaml_value 'kitty.styleNormal')
        local bold=$(read_yaml_value 'kitty.styleBold')
        local italic=$(read_yaml_value 'kitty.styleItalic')
        local bolditalic=$(read_yaml_value 'kitty.styleBoldItalic')

        # Count presets for display
        local preset_count=$(list_presets | wc -l)

        # Build menu with current values embedded
        local choice=$(gum choose \
            "ðŸ“ Font Family         â†’ $font" \
            "ðŸ“ Font Size           â†’ $size" \
            "ðŸ“ Cell Height         â†’ $height" \
            "ðŸ“ Cell Width          â†’ $width" \
            "ðŸ”¤ Normal Style        â†’ $normal" \
            "ðŸ”¤ Bold Style          â†’ $bold" \
            "ðŸ”¤ Italic Style        â†’ $italic" \
            "ðŸ”¤ Bold+Italic Style   â†’ $bolditalic" \
            "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" \
            "ðŸ“¦ Presets             â†’ $preset_count saved" \
            "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" \
            "ðŸ’¾ Save and Exit" \
            "âŒ Discard and Exit" \
            --height 18 \
            --header "Select setting to modify:" \
            ${last_choice:+--selected="$last_choice"})

        case "$choice" in
            "ðŸ“ Font Family"*)
                last_choice="$choice"
                select_font_family
                ;;
            "ðŸ“ Font Size"*)
                last_choice="$choice"
                adjust_font_size
                ;;
            "ðŸ“ Cell Height"*)
                last_choice="$choice"
                adjust_cell_dimension "Height"
                ;;
            "ðŸ“ Cell Width"*)
                last_choice="$choice"
                adjust_cell_dimension "Width"
                ;;
            "ðŸ”¤ Normal Style"*)
                last_choice="$choice"
                select_font_style "Normal" "kitty.styleNormal"
                ;;
            "ðŸ”¤ Bold Style"*)
                last_choice="$choice"
                select_font_style "Bold" "kitty.styleBold"
                ;;
            "ðŸ”¤ Italic Style"*)
                last_choice="$choice"
                select_font_style "Italic" "kitty.styleItalic"
                ;;
            "ðŸ”¤ Bold+Italic Style"*)
                last_choice="$choice"
                select_font_style "Bold+Italic" "kitty.styleBoldItalic"
                ;;
            "ðŸ“¦ Presets"*)
                last_choice="$choice"
                presets_menu
                ;;
            "ðŸ’¾ Save and Exit")
                clear
                log_success "Changes saved!"
                rm -f "$BACKUP_FILE"
                exit 0
                ;;
            "âŒ Discard and Exit")
                clear
                restore_backup
                apply_and_reload
                log_info "Changes discarded"
                exit 0
                ;;
            "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
                # Separator - do nothing, will refresh
                continue
                ;;
            "")
                # Esc pressed, treat as discard
                clear
                restore_backup
                apply_and_reload
                log_info "Changes discarded"
                exit 0
                ;;
        esac
    done
}

# ============================================================================
# Main
# ============================================================================

main() {
    # Check dependencies
    for cmd in gum yq chezmoi fc-list fzf; do
        if ! command -v $cmd &> /dev/null; then
            log_error "Required command not found: $cmd"
            exit 1
        fi
    done

    log_info "Starting Kitty Font Picker..."
    create_backup

    main_menu
}

main "$@"
